/*
 * lambda-calculus-evaluator 1.0.0
 * Evaluator tool for lambda calculus expressions. Can be used with evaluation strategies such as normal order evaluation, call by value and call by name.
 * https://github.com/royswastik/lambda-calculus-evaluator#readme
 *
 * Copyright 2018, Swastik Roy
 * Released under the LGPL-3.0 license.
*/

function colorParens(e,t){for(var r="",E=0,p=0;p<e.length;p++){var x=e[p],n="";if("("==x&&E++,")"!=x&&"("!=x||(n+="color:"+color[E%color.length]+";"),")"==x&&E--,!isNaN(parseInt(t[p],10)))parseInt(t[p]);r+='<span style="'+n+'">'+x+"</span>"}return r="<div>"+r+"</div>"}function redexLines(e,t){for(var r=0,E=!1,p="";++r;){var x="";E=!1;for(var n=0;n<e.length;n++)!isNaN(parseInt(t[n]))&&parseInt(t[n])>=r?(x+='<span style="color:transparent; border-bottom: solid 2px '+color[r%color.length]+"; padding-bottom: "+10*r+'px;">'+e[n]+"</span>",E=!0):x+='<span style="color:transparent;">'+e[n]+"</span>";if(0==E)break;p+=x='<div id="line'+r+'">'+x+"</div>"}return p}function isValue(e){return e.type==EXPRESSION_TYPE.PARENTHESIS?isValue(e.exp):!e.redex}function isRedex(e){return e.type==EXPRESSION_TYPE.PARENTHESIS?this.isValue(e.exp):e.redex}function toChurchNumber(e){for(var t="z";0<e--;)t="z"==t?"s "+t:"s ("+t+")";return"(Ls.Lz."+t+")"}function expandExpression(e){var t=JSON.parse(JSON.stringify(e));return replaceReservedExpressions(t),t}function getReservedExpressionString(e){if(e=e.toLowerCase(),isNaN(parseInt(e))){if(reserved[e])return reserved[e]}else if(0<=(e=parseInt(e))&&e<=20)return toChurchNumber(e);return e}function replaceReservedExpressions(e){if(e.type==EXPRESSION_TYPE.ABSTRACTION)replaceReservedExpressions(e.body.exp);else if(e.type==EXPRESSION_TYPE.APPLICATION)replaceReservedExpressions(e.exp1),replaceReservedExpressions(e.exp2);else if(e.type==EXPRESSION_TYPE.VARIABLE){if(e.type==EXPRESSION_TYPE.VARIABLE){var t=getReservedExpressionString(e.exp);if(t!=e.exp){var r=Exp(t);for(var E in e)delete e[E];for(var E in r)e[E]=r[E]}}}else e.type==EXPRESSION_TYPE.PARENTHESIS&&replaceReservedExpressions(e.exp)}BindingUtil={getFreeVariables:function(e){var t={};return function e(t,r,E){var p=JSON.parse(JSON.stringify(r));t.type==EXPRESSION_TYPE.ABSTRACTION?(p[t.argument]=!0,e(t.body.exp,p,E)):t.type==EXPRESSION_TYPE.APPLICATION?(e(t.exp1,p,E),e(t.exp2,p,E)):t.type==EXPRESSION_TYPE.VARIABLE?r[t.exp]||(E[t.exp]=!0):t.type==EXPRESSION_TYPE.PARENTHESIS&&e(t.exp,p,E)}(e,{},t),t}},BaseEvaluator=function(E){return{isValue:isValue,evaluate:function(e){var t={type:EXPRESSION_TYPE.PARENTHESIS,exp:e};E(t),refreshText(t.exp),unsetRedexLevels(t.exp),setRedexLevels(t.exp,0);var r={redexIndex:t.exp.text};return setRedexIndexes(t.exp,0,r),console.log(t.exp.text),t.exp}}},NormalOrderEvaluator=BaseEvaluator(function(e){var t=null;if(e.type==EXPRESSION_TYPE.ABSTRACTION)(t=arguments.callee(e.body.exp))&&(e.body.exp=t);else if(e.type==EXPRESSION_TYPE.APPLICATION){if(isRedex(e)){var r=reduce(e);if(e.text===r.exp.text)return;if(JSON.stringify(r)!=JSON.stringify(e))return r;var E=arguments.callee(e.exp2);return void(E&&(e.exp2=E))}var p=JSON.stringify(e.exp1);(t=arguments.callee(e.exp1))&&(e.exp1=t),p==JSON.stringify(e.exp1)&&(t=arguments.callee(e.exp2))&&(e.exp2=t);var x=e.exp1.type==EXPRESSION_TYPE.APPLICATION?"("+e.exp1.text+") "+e.exp2.text:e.exp1.text+" "+e.exp2.text;e.text=x}else if(e.type==EXPRESSION_TYPE.VARIABLE);else if(e.type==EXPRESSION_TYPE.PARENTHESIS){var n=JSON.stringify(e.exp);if((t=arguments.callee(e.exp))&&(e.exp=t),e.text="("+e.exp.text+")",n!=JSON.stringify(t))return t}}),CallByValueEvaluator=BaseEvaluator(function(e){var t=null;if(e.type==EXPRESSION_TYPE.ABSTRACTION);else if(e.type==EXPRESSION_TYPE.APPLICATION){if(isRedex(e)){if(!isValue(e.exp2))return void((t=arguments.callee(e.exp2))&&(e.exp2=t));var r=reduce(e);if(e.text===r.exp.text)return;if(JSON.stringify(r)!=JSON.stringify(e))return r}else{var E=JSON.stringify(e.exp2);(t=arguments.callee(e.exp2))&&(e.exp2=t),E==JSON.stringify(e.exp2)&&(t=arguments.callee(e.exp1))&&(e.exp1=t)}var p=e.exp1.type==EXPRESSION_TYPE.APPLICATION?"("+e.exp1.text+") "+e.exp2.text:e.exp1.text+" "+e.exp2.text;e.text=p}else if(e.type==EXPRESSION_TYPE.VARIABLE);else if(e.type==EXPRESSION_TYPE.PARENTHESIS){var x=JSON.stringify(e.exp);if((t=arguments.callee(e.exp))&&(e.exp=t),e.text="("+e.exp.text+")",x!=JSON.stringify(t))return t}}),CallByNameEvaluator=BaseEvaluator(function(e){var t=null;if(e.type==EXPRESSION_TYPE.ABSTRACTION);else if(e.type==EXPRESSION_TYPE.APPLICATION){if(isRedex(e)){var r=reduce(e);if(e.text===r.exp.text)return;return JSON.stringify(r)!=JSON.stringify(e)?r:void((t=arguments.callee(e.exp2))&&(e.exp2=t))}var E=JSON.stringify(e.exp1);(t=arguments.callee(e.exp1))&&(e.exp1=t),E==JSON.stringify(e.exp1)&&(t=arguments.callee(e.exp2))&&(e.exp2=t);var p=e.exp1.type==EXPRESSION_TYPE.APPLICATION?"("+e.exp1.text+") "+e.exp2.text:e.exp1.text+" "+e.exp2.text;e.text=p}else if(e.type==EXPRESSION_TYPE.VARIABLE);else if(e.type==EXPRESSION_TYPE.PARENTHESIS){var x=JSON.stringify(e.exp);if((t=arguments.callee(e.exp))&&(e.exp=t),e.text="("+e.exp.text+")",x!=JSON.stringify(t))return t}}),EXPRESSION_TYPE={APPLICATION:"application",ABSTRACTION:"abstraction",VARIABLE:"variable",PARENTHESIS:"parenthesis"},LAMBDA="L";var Exp=function(r){r=r.trim();var e=function(){if("("==r[0]&&")"==r[r.length-1]){for(var e=0,t=0;t<r.length;t++)if("("==r[t]&&e++,")"==r[t]&&e--,0==e&&t!=r.length-1)return EXPRESSION_TYPE.APPLICATION;return EXPRESSION_TYPE.PARENTHESIS}return r[0]==LAMBDA?EXPRESSION_TYPE.ABSTRACTION:1<r.split(" ").length?EXPRESSION_TYPE.APPLICATION:EXPRESSION_TYPE.VARIABLE}(),t={};return e==EXPRESSION_TYPE.ABSTRACTION?t=Parser.parseAbstraction(r):e==EXPRESSION_TYPE.APPLICATION?t=Parser.parseApplication(r):e==EXPRESSION_TYPE.VARIABLE?t=Parser.parseVariable(r):e==EXPRESSION_TYPE.PARENTHESIS&&(t=Parser.parseParenthesis(r)),t.type=e,t},reserved={mult:"(Lm.Ln. m ((Lm. Ln. Ls. Lz.m s (n s z)) n) "+toChurchNumber(0)+")",plus:"(Lm.Ln.Ls.Lz.m s (n s z))",succ:"(Ln.Ls.Lz.s (n s z))",true:"(Lx.Ly.x)",false:"(Lx.Ly.y)",and:"(Lb.Lc.b c (Lx.Ly.y))",or:"(Lb.Lc.b (Lx.Ly.x) c)",pair:"(Lf.Ls.Lb.b f s)",first:"(Lp.p (Lx.Ly.x))",second:"(Lp.p (Lx.Ly.y))"};function parse_expression(e){return Exp(e)}function parenthesizeAbstractions(e){if(e[0]==LAMBDA)return e;for(var t="",r=0,E=-1,p=0,x=0;x<e.length;x++){var n=e[x];-1==E&&(n==LAMBDA&&(t+="(",p++),t+=n),"("==n&&(0==r&&(E=x),r++),")"==n&&0==--r&&(t+=parenthesizeAbstractions(e.substring(E+1,x))+n,E=-1)}for(;p--;)t+=")";return t}function setRedexLevels(e,t){if(e.type==EXPRESSION_TYPE.ABSTRACTION)setRedexLevels(e.body.exp,t);else if(e.type==EXPRESSION_TYPE.APPLICATION){var r=t;ifAbstraction(e.exp1)&&(e.redex=t+1,r=t+1),setRedexLevels(e.exp1,r),setRedexLevels(e.exp2,r)}else e.type==EXPRESSION_TYPE.VARIABLE||e.type==EXPRESSION_TYPE.PARENTHESIS&&setRedexLevels(e.exp,t)}function unsetRedexLevels(e){e.type==EXPRESSION_TYPE.ABSTRACTION?unsetRedexLevels(e.body.exp):e.type==EXPRESSION_TYPE.APPLICATION?(e.redex&&delete e.redex,unsetRedexLevels(e.exp1),unsetRedexLevels(e.exp2)):e.type==EXPRESSION_TYPE.VARIABLE||e.type==EXPRESSION_TYPE.PARENTHESIS&&unsetRedexLevels(e.exp)}function setCharAt(e,t,r){return t>e.length-1?e:e.substr(0,t)+r+e.substr(t+1)}function setRedexIndexes(e,t,r){if(e.type==EXPRESSION_TYPE.ABSTRACTION)setRedexIndexes(e.body.exp,t+(e.text.length-e.body.text.length-1),r);else if(e.type==EXPRESSION_TYPE.APPLICATION){if(e.redex)for(var E=t;E<t+e.text.length;E++)r.redexIndex=setCharAt(r.redexIndex,E,e.redex);var p=e.text.length-e.exp1.text.length-e.exp2.text.length;setRedexIndexes(e.exp1,1<p?t+1:t,r),setRedexIndexes(e.exp2,t+(e.text.length-e.exp2.text.length),r)}else e.type==EXPRESSION_TYPE.VARIABLE||e.type==EXPRESSION_TYPE.PARENTHESIS&&setRedexIndexes(e.exp,t+1,r)}function ifAbstraction(e){return e.type!=EXPRESSION_TYPE.PARENTHESIS?e.type==EXPRESSION_TYPE.ABSTRACTION:e.type==EXPRESSION_TYPE.ABSTRACTION||ifAbstraction(e.exp)}function refreshText(e){if(e.type==EXPRESSION_TYPE.ABSTRACTION){refreshText(e.body.exp);var t=e.body.exp.type==EXPRESSION_TYPE.PARENTHESIS||e.body.exp.type==EXPRESSION_TYPE.VARIABLE?e.body.exp.text:"("+e.body.exp.text+")";e.text=LAMBDA+e.argument+"."+t}else if(e.type==EXPRESSION_TYPE.APPLICATION){refreshText(e.exp1),refreshText(e.exp2);var r=e.exp1.type==EXPRESSION_TYPE.APPLICATION?"("+e.exp1.text+") "+e.exp2.text:e.exp1.text+" "+e.exp2.text;e.text=r}else e.type==EXPRESSION_TYPE.VARIABLE?e.text=e.exp:e.type==EXPRESSION_TYPE.PARENTHESIS&&(refreshText(e.exp),e.text=e.exp.type==EXPRESSION_TYPE.PARENTHESIS?e.exp.text:"("+e.exp.text+")")}function reduce(e){var t=JSON.stringify(e),r=JSON.parse(t),E=BindingUtil.getFreeVariables(r.exp2),p=getAbstraction(r.exp1);JSON.stringify(p.body.exp);alphaRename(E,p.argument,p.body.exp);var x={type:EXPRESSION_TYPE.PARENTHESIS,exp:p.body.exp};return replaceOccurances(p.argument,r.exp2,x),x.exp.type==EXPRESSION_TYPE.APPLICATION&&x.exp.type!=EXPRESSION_TYPE.PARENTHESIS?(x.text="("+x.exp.text+")",x):x.exp}function getAbstraction(e){return e.type==EXPRESSION_TYPE.ABSTRACTION?e:getAbstraction(e.exp)}function replaceOccurances(e,t,r){if(r.type==EXPRESSION_TYPE.ABSTRACTION){if(r.argument!=e){replaceOccurances(e,t,r.body.exp)&&(r.body.exp=t);var E=r.body.exp.type==EXPRESSION_TYPE.PARENTHESIS||r.body.exp.type==EXPRESSION_TYPE.VARIABLE?r.body.exp.text:"("+r.body.exp.text+")";r.text=LAMBDA+r.argument+"."+E}}else if(r.type==EXPRESSION_TYPE.APPLICATION){replaceOccurances(e,t,r.exp1)&&(r.exp1=t),replaceOccurances(e,t,r.exp2)&&(r.exp2=t);var p=r.exp1.type==EXPRESSION_TYPE.APPLICATION?"("+r.exp1.text+") "+r.exp2.text:r.exp1.text+" "+r.exp2.text;r.text=p}else if(r.type==EXPRESSION_TYPE.VARIABLE){if(r.exp==e)return!0}else r.type==EXPRESSION_TYPE.PARENTHESIS&&(replaceOccurances(e,t,r.exp)&&(r.exp=t),r.text="("+r.exp.text+")");return!1}function alphaRename(e,t,r){if(r.type==EXPRESSION_TYPE.ABSTRACTION){var E=r.argument;if(E!=t){var p=BindingUtil.getFreeVariables(r.body.exp);if(p[t]&&e[E]){var x=getNewName(E,e,p);renameOccurances(E,x,r.body.exp),r.argument=x}}alphaRename(e,t,r.body.exp)}else r.type==EXPRESSION_TYPE.APPLICATION?(alphaRename(e,t,r.exp1),alphaRename(e,t,r.exp2)):r.type==EXPRESSION_TYPE.VARIABLE||r.type==EXPRESSION_TYPE.PARENTHESIS&&alphaRename(e,t,r.exp)}function renameOccurances(e,t,r){r.type==EXPRESSION_TYPE.ABSTRACTION?r.argument!=e&&renameOccurances(e,t,r.body.exp):r.type==EXPRESSION_TYPE.APPLICATION?(renameOccurances(e,t,r.exp1),renameOccurances(e,t,r.exp2)):r.type==EXPRESSION_TYPE.VARIABLE?r.exp==e&&(r.exp=t,r.text=t):r.type==EXPRESSION_TYPE.PARENTHESIS&&renameOccurances(e,t,r.exp)}function getNewName(e,t,r){for(var E=1,p=e+E;t[p]||r[p];)p=e+E,E++;return p}Parser={parseAbstraction:function(e){for(var t="",r=-1,E=1;E<e.length;E++){if("."==e[E]){r=E;break}t+=e[E]}var p=e.substring(r+1,e.length),x=Exp(p.trim()),n=x.type==EXPRESSION_TYPE.PARENTHESIS||x.type==EXPRESSION_TYPE.VARIABLE?x.text:"("+x.text+")";return{argument:t.trim(),body:{text:x.text,exp:x},text:LAMBDA+t+"."+n}},parseApplication:function(e){for(var t="",r=0,E=-1,p=(e=parenthesizeAbstractions(e)).length-1;0<=p;p--){if(t=e[p]+t,")"==e[p]&&r++,0==r&&" "==e[p]&&"("!=e[p+1]){if(-1!=E)break;E=p}if("("==e[p]&&0==--r){if(-1!=E)break;E=p}}var x=Exp(e.substring(0,E).trim()),n=Exp(e.substring(E,e.length).trim());return{exp1:x,exp2:n,text:x.type==EXPRESSION_TYPE.APPLICATION?"("+x.text+") "+n.text:x.text+" "+n.text}},parseParenthesis:function(e){e=(e=e.trim()).substring(1,e.length-1).trim();var t=Exp(e.trim());return{text:"("+t.text+")",exp:t}},parseVariable:function(e){return{text:e.trim(),exp:e.trim()}}};